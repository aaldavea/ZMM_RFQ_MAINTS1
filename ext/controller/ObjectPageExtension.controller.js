/*
 * Copyright (C) 2009-2020 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.controller("zgestion.petofer.ext.controller.ObjectPageExtension",{onInit:function(){var o="REQUEST_FOR_QUOTATION";var m="D";var k="RequestForQuotation";var s="RFQLifecycleStatus";var c=this;var C="";var r="",a="02";var h=true;var b=c.byId("idOutputControlContainer");if(b){if(!c._oOutputComponent){c._oOutputComponent=sap.ui.getCore().createComponent({name:"sap.ssuite.fnd.om.outputcontrol.outputitems",id:c.createId("OutputComponent"),settings:{editMode:m,objectId:C,objectType:o,showTableTitle:false,hideIssueOutputAction:h}});b.setComponent(c._oOutputComponent);}b.attachModelContextChange(function(e){if(b.getBindingContext()){C=b.getBindingContext().getProperty(k);r=b.getBindingContext().getProperty(s);if(r!==undefined&&r===a){h=false;}else{h=true;}if(c._oOutputComponent.getProperty("objectId")!==C){if(!isNaN(C)){while(C.length<10){C='0'+C;}}c._oOutputComponent.setObjectId(C);c._oOutputComponent.setHideIssueOutputAction(h);c._oOutputComponent.refresh();}}});}this.extensionAPI.getTransactionController().attachAfterActivate(function(p){p.activationPromise.then(function(R){C=R.data.RequestForQuotation;r=R.data.RFQLifecycleStatus;if(r!==undefined&&r===a){h=false;}else{h=true;}c._oOutputComponent.setObjectId(C);c._oOutputComponent.setHideIssueOutputAction(h);c._oOutputComponent.refresh();});});},onCreateWithContext:function(e){var v=this.getView();var m=v.getModel();var p=v.getBindingContext().getPath();var P=this.extensionAPI.getSelectedContexts("zgestion.petofer::sap.suite.ui.generic.template.ObjectPage.view.Details::C_RequestForQuotationEnhWD--Bidders::Table")[0].getPath();var a=m.getProperty(p).RequestForQuotation;var s=m.getProperty(P).Supplier;var i=m.getProperty(P).HasNoSupplierQuotation;if(i){this.oCrossAppNavigator=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(this.oCrossAppNavigator&&this.oCrossAppNavigator.toExternal){this.oCrossAppNavigator.toExternal({target:{semanticObject:"SupplierQuotation",action:"manage"},params:{RequestForQuotation:a,Supplier:s,mode:"createWithContext"}});}}else{this._showErrorDialog(v);}},onGetBidderProposal:function(e){var v=this.getView();var c=v.getBindingContext();var p=v.getModel().getProperty(c.getPath()).PurchasingOrganization;if(p!==""){if(!this._oBidderProposalDialog){this._oBidderProposalDialog=sap.ui.xmlfragment("zgestion.petofer.ext.fragment.BidderProposal",this);this._oBidderProposalDialog.setBusy(true);this._bidderProposalModel=new sap.ui.model.json.JSONModel({});this._oBidderProposalDialog.setModel(this._bidderProposalModel,"bidderProposalModel");v.addDependent(this._oBidderProposalDialog);var i=function(V,a){var f=parseInt(V,10);var g=parseInt(a,10);if(f===g){return 0;}return(f<g?-1:1);};var s=new sap.ui.model.Sorter("NumberOfCoveredItems",true,false,i);var S=new sap.ui.model.Sorter("DaysSinceLastOrder",false,false,i);var o=new sap.ui.model.Sorter("NumberOfPurchaseOrderItems",true,false,i);var b=this._oBidderProposalDialog.getBinding("items");b.sort([s,S,o]);}var P=this.extensionAPI.invokeActions("/A748DE3ED04E5C405554Get_bidder_proposals",c);P.then(jQuery.proxy(this._onBidderProposalSuccessCallback,this),jQuery.proxy(this._onBidderProposalErrorCallback,this));}else{var d=new sap.m.Dialog({title:v.getModel("i18n").getResourceBundle().getText("BIDDER_PROPOSAL_INFO_DIALOG_TITLE"),type:"Message",state:"None",content:new sap.m.Text({text:v.getModel("i18n").getResourceBundle().getText("NO_PURCH_ORG_SET")}),beginButton:new sap.m.Button({text:v.getModel("i18n").getResourceBundle().getText("LT_OK"),press:function(){d.close();}}),afterClose:function(){d.destroy();}}).open();}},addBidderProposals:function(e){var a=this.extensionAPI;var m=this.getView().getModel();var p=this.getView().getBindingContext().getPath();var s=e.getParameter("selectedItems");for(var i=0;i<s.length;i++){var P=s[i].getBindingContextPath();var o=this._bidderProposalModel.getProperty(P);m.create(p+"/to_RFQBidderEnhWD",{"Supplier":o.Supplier},{success:function(){a.refresh("zgestion.petofer::sap.suite.ui.generic.template.ObjectPage.view.Details::C_RequestForQuotationEnhWD--Bidders::Table");a.getTransactionController().executeSideEffects({sourceEntities:["to_RFQBidderEnhWD"]});}});}var b=e.getSource().getBinding("items");b.filter([]);this._bidderProposalModel.setData({});},searchBidderProposals:function(e){var v=e.getParameter("value");var f=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Supplier",sap.ui.model.FilterOperator.Contains,v),new sap.ui.model.Filter("SupplierName",sap.ui.model.FilterOperator.Contains,v)],and:false});var b=e.getSource().getBinding("items");b.filter([f]);},onCancel:function(e){this._bidderProposalModel.setData({});},_onBidderProposalSuccessCallback:function(r){if(r[0]&&r[0].response){this._oBidderProposalDialog.setBusy(false);if(r[0].response.data.results.length>0){this._bidderProposalModel.setData(r[0].response.data);this._oBidderProposalDialog.open();}else{var v=this.getView();var d=new sap.m.Dialog({title:v.getModel("i18n").getResourceBundle().getText("BIDDER_PROPOSAL_INFO_DIALOG_TITLE"),type:"Message",state:"None",content:new sap.m.Text({text:v.getModel("i18n").getResourceBundle().getText("BIDDER_PROPOSAL_INFO_DIALOG_TEXT")}),beginButton:new sap.m.Button({text:v.getModel("i18n").getResourceBundle().getText("LT_OK"),press:function(){d.close();}}),afterClose:function(){d.destroy();}}).open();}}},_onBidderProposalErrorCallback:function(){this._oBidderProposalDialog.setBusy(false);},_showErrorDialog:function(v){var d=new sap.m.Dialog({title:v.getModel("i18n").getResourceBundle().getText("LT_ERROR_DIALOG_TITLE"),type:"Message",state:"Error",content:new sap.m.Text({text:v.getModel("i18n").getResourceBundle().getText("CWR_NOT_POSSIBLE")}),beginButton:new sap.m.Button({text:v.getModel("i18n").getResourceBundle().getText("LT_OK"),press:function(){d.close();}}),afterClose:function(){d.destroy();}}).open();},onAssignToLT:function(){var l=sap.ui.view({type:sap.ui.core.mvc.ViewType.XML,viewName:"zgestion.petofer.ext.view.LegalTransactionVH"});this._oLTVHDialog=new sap.m.Dialog({title:"{i18n|sap.suite.ui.generic.template.ObjectPage|C_RequestForQuotationEnhWD>LT_SEARCH}",contentWidth:"100%",contentHeight:"100%",stretchOnPhone:true,showCloseButton:true,beginButton:new sap.m.Button({text:"{i18n|sap.suite.ui.generic.template.ObjectPage|C_RequestForQuotationEnhWD>LT_OK}",press:jQuery.proxy(this._onPressAssignLT,this,l)}),endButton:new sap.m.Button({text:"{i18n|sap.suite.ui.generic.template.ObjectPage|C_RequestForQuotationEnhWD>LT_CANCEL}",press:function(){this.getParent().close();}})});this._oLTVHDialog.addContent(l);this.getView().addDependent(this._oLTVHDialog);jQuery.sap.syncStyleClass("sapUiSizeCompact",this.getView(),this._oLTVHDialog);this._oLTVHDialog.setModel(this.getView().getModel());this._oLTVHDialog.open();},_onPressAssignLT:function(l){var I=l.byId("smartTableLTVH").getTable().getSelectedItems();var r=l.getBindingContext().getPath();var a=l.getModel().getProperty(r).RequestForQuotation;var p;for(var i=0;i<I.length;i++){p=I[i].getBindingContextPath();var b=this.getView().getModel().getProperty(p).LegalTransaction;var c=this.getView().getModel("assignLT");c.callFunction("/AssignLinkdObjToLglTransExt",{success:jQuery.proxy(this._onAssigLTSuccessCallback,this),error:jQuery.proxy(this._onAssigLTErrorCallback,this),method:"POST",urlParameters:{LglCntntMLinkdObj:a,LegalTransaction:b,Lglcntntmintegrationlink:"RFQ"}});}},_onAssigLTSuccessCallback:function(d){this._oLTVHDialog.close();var b=this.getView().getModel("i18n").getResourceBundle();var l=d.LegalTransaction;sap.m.MessageToast.show(b.getText("LT_SUCCESS",[l]));this.extensionAPI.refresh("zgestion.petofer::sap.suite.ui.generic.template.ObjectPage.view.Details::C_RequestForQuotationEnhWD--LegalTransaction::Table");},_onAssigLTErrorCallback:function(r){var R=r.responseText;var e=JSON.parse(R);var E=e.error.message.value;var d=new sap.m.Dialog({title:"{i18n|sap.suite.ui.generic.template.ObjectPage|C_RequestForQuotationEnhWD>LT_ERROR_DIALOG_TITLE}",type:"Message",state:"Error",content:new sap.m.Text({text:E}),beginButton:new sap.m.Button({text:"{i18n|sap.suite.ui.generic.template.ObjectPage|C_RequestForQuotationEnhWD>LT_OK}",press:function(){d.close();}}),afterClose:function(){d.destroy();}});this.getView().addDependent(d);d.open();},onChangeLogAction:function(){if(!this._oChangeLogDialog){this._oChangeLogDialog=sap.ui.xmlfragment("changeLogFragment","zgestion.petofer.ext.fragment.ChangeLog",this);this.getView().addDependent(this._oChangeLogDialog);}this._oChangeLogDialog.bindElement({path:this.getView().getBindingContext().getPath(),events:{change:jQuery.proxy(function(){sap.ui.getCore().byId(sap.ui.core.Fragment.createId("changeLogFragment","changeLogDialogId")).setTitle(this.getView().getModel("i18n").getResourceBundle().getText("@CHANGELOG_TITLE",[this.getView().getBindingContext().getObject().RequestForQuotation]));this._oChangeLogDialog.open();},this),dataReceived:jQuery.proxy(function(){},this)}});},onBeforeChangeLogRebind:function(e){var b=e.getParameters().bindingParams,t=this;if(!b.sorter.length){var d=sap.ui.core.format.DateFormat.getDateTimeInstance({style:"medium"});b.sorter.push(new sap.ui.model.Sorter("CreationDateTime",true,function(c){var D=c.getProperty("CreationDateTime");return{key:D.toString(),text:t.getView().getModel("i18n").getResourceBundle().getText("@CHANGELOG_GROUP_TITLE",[d.format(D),c.getProperty("FullName")])};}));}},handleChangeLogSearch:function(e){var v=e.getSource().getValue(),t=e.getSource().getParent().getParent().getTable(),b=t.getBinding("items"),m=b.getModel();if(v!==""){b.sCustomParams=m.createCustomParams({custom:{search:v}});}else{b.sCustomParams=[];}b.filter();},onCloseChangeLogDialog:function(){this._oChangeLogDialog.destroy();this._oChangeLogDialog=null;}});